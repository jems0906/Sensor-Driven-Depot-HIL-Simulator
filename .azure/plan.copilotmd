# Azure Deployment Plan for HIL Depot Simulator Project

## **Goal**
Deploy the HIL Depot Simulator project to Azure using AZD with bicep infrastructure as code.

## **Project Information**
**HIL Depot Simulator**  
- **Stack**: Python Flask 2.3+ web application  
- **Type**: Hardware-in-the-Loop simulation dashboard with real-time monitoring  
- **Database**: SQLite (to be migrated to Azure SQL Database)  
- **Features**: Sensor simulation, control logic, fault injection, web dashboard with Chart.js  
- **Entry Point**: dashboard/app.py  
- **Hosting**: Azure App Service

## **Azure Resources Architecture**
> **Install the mermaid extension in IDE to view the architecture.**

```mermaid
graph TD
%% Services
svcazureappservice_depotsimulatorweb["`Name: depot-simulator-web
Path: dashboard
Language: python`"]
subgraph "Compute Resources"
%% Resources
azureappservice_depotsimulatorweb("`depot-simulator-web (Azure App Service)`")
end
subgraph "Dependency Resources"
%% Dependency Resources
azuresqldatabase_sqlitedb["`depot-db (Azure SQL Database)`"]
azureapplicationinsights_insights["`app-insights (Application Insights)`"]
azurekeyvault_keyvault["`key-vault (Key Vault)`"]
end
%% Relationships
svcazureappservice_depotsimulatorweb --> |"hosted on"| azureappservice_depotsimulatorweb
azureappservice_depotsimulatorweb -.-> |"system-identity"| azuresqldatabase_sqlitedb
azureappservice_depotsimulatorweb -.-> |"system-identity"| azureapplicationinsights_insights
azureappservice_depotsimulatorweb -.-> |"system-identity"| azurekeyvault_keyvault
```

- The app service hosts the Flask web dashboard and simulation engine
- The app service connects to Azure SQL Database using managed identity for data persistence
- Application Insights provides monitoring and telemetry for the simulation system
- Key Vault securely stores database connection strings and configuration

## **Recommended Azure Resources**

**Application: HIL Depot Simulator**
- **Hosting Service Type**: Azure App Service
- **SKU**: S1 Standard (1 vCore, 1.75GB RAM) - Suitable for development and testing workloads
- **Configuration**:
    - Language: Python 3.11
    - Environment Variables: 
      - `SCM_DO_BUILD_DURING_DEPLOYMENT=true`
      - `DATABASE_URL` (from Key Vault)
      - `FLASK_ENV=production`
- **Dependencies Resource**:
    - **Dependency Name**: depot-db
    - **SKU**: S0 Standard (10 DTUs, 250GB storage) - Basic performance for simulation data
    - **Service Type**: Azure SQL Database
    - **Connection Type**: Managed Identity with Service Connector
    - **Environment Variables**: 
      - `AZURE_SQL_CONNECTIONSTRING` (managed by Service Connector)

## **Recommended Supporting Services**
- **Application Insights**: Monitor simulation performance and fault detection metrics
- **User-Assigned Managed Identity**: Secure access between services
- **Log Analytics Workspace**: Centralized logging for all App Service logs
- **Key Vault**: Store database connection strings and sensitive configuration

## **Recommended Security Configurations**
- User-Assigned Managed Identity must have permissions into the Key Vault
- User-Assigned Managed Identity must be assigned to all supported resources
- SQL Database firewall configured to allow App Service access only

## **Execution Steps**

### 1. Create Azure Infrastructure Files for AZD ‚úÖ
   - [ ] Provisioning tool: AZD. Expected files: azure.yaml, infra/main.bicep, infra/main.parameters.json
   - [ ] Get current subscriptionID and call `appmod-get-available-region-sku` for available regions and SKUs
   - [ ] Check if expected files exist and validate Azure resources match plan requirements
   - [ ] Generate missing files using `appmod-get-iac-rules` for bicep best practices
   - [ ] Call `get_errors` on generated files and iterate on any errors
   - [ ] Add postprovision hooks in azure.yaml for database connections with Service Connector

### 2. Environment Setup for AZD üî≤
   - [ ] Install AZ CLI and AZD if not installed
   - [ ] Run `azd env new hil-depot-sim --no-prompt` to create environment
   - [ ] Set required environment variables using `azd env set`
   - [ ] Set subscription and create resource group with AZ CLI
   - [ ] Install Service Connector extension: `az extension add --name serviceconnector-passwordless --upgrade`

### 3. Deployment üî≤
   - [ ] Run `azd provision --preview --no-prompt` for dry run validation
   - [ ] Execute `azd up --no-prompt` for full deployment
   - [ ] Validate deployment with `appmod-get-azd-app-logs`

### 4. Summarize Results üî≤
   - [ ] Use `appmod-summarize-result` tool to generate deployment summary
   - [ ] Create `.azure/summary.copilotmd` with final results

## **Progress Tracking**
Progress will be tracked in `.azure/progress.copilotmd` with:
- ‚úÖ Completed tasks
- üî≤ Pending tasks  
- ‚ùå Failed tasks with error notes

## **Tools Checklist**
- [ ] appmod-get-available-region-sku
- [ ] appmod-get-iac-rules
- [ ] appmod-summarize-result